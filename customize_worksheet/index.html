<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教師自編考卷數位助教 V12 (全能版)</title>
    
    <link rel="stylesheet" href="assets/css/style.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body>

    <div class="control-panel">
        <div style="position: absolute; top: 20px; right: 20px;">
            <button id="btn-ai-settings" class="btn-small btn-outline">🤖 設定 AI</button>
        </div>

        <div style="text-align: center; margin-bottom: 20px;">
            <h1 style="margin: 5px 0;">🎓 考卷數位助教</h1>
            <p style="color: #666; font-size: 0.9em;">支援 Excel、Word、PDF 匯入，結合 AI 智慧排版</p>
        </div>

        <div class="stepper-container">
            <div class="step-indicator active" data-step="1">
                <div class="circle">1</div>
                <div class="label">建立題庫</div>
            </div>
            <div class="line"></div>
            <div class="step-indicator" data-step="2">
                <div class="circle">2</div>
                <div class="label">設定對象</div>
            </div>
            <div class="line"></div>
            <div class="step-indicator" data-step="3">
                <div class="circle">3</div>
                <div class="label">輸出設定</div>
            </div>
        </div>
        
        <div class="step-section active" data-step="1">
            <div class="smart-editor-container">
                <div class="editor-toolbar">
                    <div class="toolbar-group">
                        <button id="btn-upload-file" class="btn-tool" title="匯入 Excel, Word, PDF">📂 匯入檔案</button>
                        <button id="btn-demo-data" class="btn-tool">🎲 範例</button>
                        <input type="file" id="file-questions" accept=".csv, .xlsx, .xls, .docx, .pdf" style="display: none;">
                    </div>
                    <div class="toolbar-divider"></div>
                    <div class="toolbar-group">
                        <button id="btn-ai-parse" class="btn-tool btn-ai-gradient">✨ AI 深度分析</button>
                        <span id="ai-status-badge" style="display:none;"></span>
                    </div>
                    <div class="toolbar-group" style="margin-left: auto;">
                        <button id="btn-clear-q" class="btn-tool text-danger">🗑️ 清空</button>
                    </div>
                </div>

                <div class="editor-main">
                    <div class="editor-pane input-pane">
                        <div class="pane-label">📝 題目輸入區 (支援直接貼上 Word/PDF 文字)</div>
                        <textarea id="txt-raw-q" placeholder="請在此貼上題目...&#10;1. 題目內容...&#10;(A)選項 (B)選項"></textarea>
                    </div>
                    <div class="editor-pane preview-pane">
                        <div class="pane-label">👁️ 辨識結果 (<span id="preview-count">0</span> 題)</div>
                        <div id="preview-parsed-q" class="preview-content">
                            <div class="empty-state">👈 請在左側輸入文字<br>或點擊上方「匯入檔案」</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="nav-buttons right">
                <button class="btn-primary btn-next" data-action="next">下一步：設定對象 ➔</button>
            </div>
        </div>

        <div class="step-section" data-step="2" style="display: none;">
            
            <div class="mode-tabs">
                <button class="mode-tab active" data-mode="quiz">📝 全班測驗 / AB卷</button>
                <button class="mode-tab" data-mode="error">🎯 錯題訂正</button>
            </div>

            <div id="panel-quiz" class="mode-panel">
                <div class="input-group">
                    <label>出題範圍 (輸入題號，留空則全選)</label>
                    <input type="text" id="input-range" placeholder="例如: 1-10, 15">
                    <div style="margin-top: 15px;">
                        <label class="checkbox-label">
                            <input type="checkbox" id="chk-randomize"> 題目隨機排序 (製作 AB 卷)
                        </label>
                    </div>
                </div>
            </div>

            <div id="panel-error" class="mode-panel" style="display: none;">
                <div class="smart-editor-container compact">
                    <div class="editor-main">
                        <div class="editor-pane input-pane">
                            <div class="pane-label">
                                ⌨️ 錯題速記 (格式: 座號: 題號)
                                <button id="btn-upload-student" class="btn-xs float-right">📂 上傳 Excel</button>
                                <input type="file" id="file-students" accept=".csv, .xlsx, .xls" style="display: none;">
                            </div>
                            <textarea id="txt-raw-s" placeholder="01: 1, 5, 8&#10;02: 3, 4&#10;王小明: 1, 10"></textarea>
                        </div>
                    </div>
                </div>
                <small id="s-status" class="status-text">尚未輸入資料</small>
            </div>

            <div class="nav-buttons split">
                <button class="btn-secondary" data-action="prev">⬅ 上一步</button>
                <button class="btn-primary btn-next" data-action="next">下一步：輸出設定 ➔</button>
            </div>
        </div>

        <div class="step-section" data-step="3" style="display: none;">
            
            <div class="panel-row">
                <div class="input-group options-group">
                    <label>試卷標題</label>
                    <input type="text" id="input-title" value="測驗卷">
                </div>
                <div class="input-group options-group">
                    <label>功能開關</label>
                    <div class="checkbox-group">
                        <button id="btn-open-settings" class="btn-small">⚙️ 欄位設定</button>
                        <label class="checkbox-label">
                            <input type="checkbox" id="chk-page-break" checked> 強制分頁
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="chk-teacher-key"> 生成解答卷
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="generation-area">
                <button id="btn-generate" class="btn-lg-primary">🚀 生成文件</button>
                <button id="btn-print" class="btn-lg-secondary" style="display: none;">🖨️ 列印 / 另存 PDF</button>
            </div>

            <div class="nav-buttons left">
                <button class="btn-secondary" data-action="prev">⬅ 上一步</button>
            </div>
        </div>
    </div>

    <div id="output-area">
        <div class="placeholder-text">(預覽區域)</div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>表格樣式設定</h2><span class="close-modal" data-target="settings-modal">&times;</span></div>
            <div class="modal-body">
                <div class="settings-pane"><div id="modal-column-list"></div><div class="modal-actions"><button id="btn-add-col-modal" class="btn-small btn-green">+ 新增</button><button id="btn-reset-col-modal" class="btn-small btn-red">重置</button></div></div>
                <div class="preview-pane"><div id="modal-preview-area" class="preview-box"></div></div>
            </div>
            <div class="modal-footer"><button id="btn-save-settings" class="btn-primary">儲存</button></div>
        </div>
    </div>

    <div id="modal-ai-settings" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header"><h2>🤖 Google AI 設定</h2><span class="close-modal" data-target="modal-ai-settings">&times;</span></div>
            <div class="modal-body">
                <label>API Key</label><input type="password" id="input-api-key" placeholder="貼上 Key..." style="width:100%; padding:8px; margin:5px 0 10px;">
                <p style="font-size:0.8em; color:#666; margin-bottom:10px;">請至 Google AI Studio 申請免費 Key。</p>
                <button id="btn-check-models" class="btn-secondary">驗證並偵測模型</button>
                <div id="model-select-area" style="display:none; margin-top:15px;"><label>選擇模型</label><select id="select-model" style="width:100%; padding:8px;"></select></div>
            </div>
            <div class="modal-footer"><button id="btn-save-ai" class="btn-primary">儲存</button></div>
        </div>
    </div>

    <script type="module" src="assets/js/main.js"></script>
</body>
</html>