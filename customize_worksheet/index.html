<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教師自編考卷數位助教 V13</title>
    
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/worksheetStyle.css">
    <link rel="stylesheet" href="assets/css/historyItem.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
</head>
<body>

    <div class="control-panel">
        <div style="position: absolute; top: 20px; right: 20px;">
            <button id="btn-ai-settings" class="btn-small btn-outline">🤖 設定 AI</button>
        </div>

        <div style="text-align: center; margin-bottom: 20px;">
            <h1 style="margin: 5px 0;">🎓 考卷數位助教</h1>
            <p style="color: #666; font-size: 0.9em;">AI 賦能：從出題、閱卷到個別化訂正的一站式解決方案</p>
        </div>

        <div class="stepper-container">
            <div class="step-indicator active" data-step="1">
                <div class="circle">1</div><div class="label">建立題庫</div>
            </div>
            <div class="line"></div>
            <div class="step-indicator" data-step="2">
                <div class="circle">2</div><div class="label">閱卷/對象</div>
            </div>
            <div class="line"></div>
            <div class="step-indicator" data-step="3">
                <div class="circle">3</div><div class="label">輸出設定</div>
            </div>
        </div>
        
        <div class="step-section active" data-step="1">
            <div class="smart-editor-container">
                <div class="editor-toolbar">
                    <div class="toolbar-group">
                        <button id="btn-upload-file" class="btn-tool" title="匯入 Excel, Word, PDF">📂 匯入檔案</button>
                        <button id="btn-demo-data" class="btn-tool">🎲 範例</button>
                        <input type="file" id="file-questions" accept=".csv, .xlsx, .xls, .docx, .pdf" style="display: none;">
                    </div>
                    <div class="toolbar-divider"></div>
                    <div class="toolbar-group">
                        <button id="btn-ai-parse" class="btn-tool btn-ai-gradient">✨ AI 分析</button>
                        <button id="btn-gen-similar" class="btn-tool" style="border:1px solid #9c27b0; color:#9c27b0; margin-left:5px;">🔮 生成類題</button>
                        <button id="btn-history" class="btn-tool" style="margin-left:5px;">📜 紀錄</button>
                    </div>
                    <div class="toolbar-group" style="margin-left: auto;">
                        <button id="btn-clear-q" class="btn-tool text-danger">🗑️ 清空</button>
                    </div>
                </div>

                <div class="editor-main">
                    <div class="editor-pane input-pane">
                        <div class="pane-label">📝 題目輸入區</div>
                        <textarea id="txt-raw-q" placeholder="請在此貼上題目文字..."></textarea>
                    </div>
                    <div class="editor-pane preview-pane">
                        <div class="pane-label">👁️ 辨識結果 (<span id="preview-count">0</span> 題)</div>
                        <div id="preview-parsed-q" class="preview-content">
                            <div class="empty-state">👈 請輸入文字或匯入檔案</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="nav-buttons right">
                <button class="btn-primary btn-next" data-action="next">下一步 ➔</button>
            </div>
        </div>

        <div class="step-section" data-step="2" style="display: none;">
            
            <div id="panel-error" class="mode-panel">
                <div class="smart-editor-container compact">
                    <div class="editor-main">
                        <div class="editor-pane input-pane">
                            <div class="pane-label">
                                <span>🎯 錯題訂正 / 閱卷 (速記區)</span>
                                <div style="display:flex; gap:5px;">
                                    <button id="btn-camera-grade" class="btn-xs btn-ai-gradient" style="border:none; color:white;">📷 拍照閱卷</button>
                                    <input type="file" id="file-grade-image" accept="image/*, .pdf" style="display: none;">
                                    <button id="btn-upload-student" class="btn-xs">📂 上傳 Excel</button>
                                    <input type="file" id="file-students" accept=".csv, .xlsx, .xls" style="display: none;">
                                </div>
                            </div>
                            <textarea id="txt-raw-s" placeholder="格式範例：&#10;01: 1, 5&#10;02: 3, 4"></textarea>
                        </div>
                    </div>
                </div>
                <small id="s-status" class="status-text">尚未輸入資料</small>
            </div>

            <div class="nav-buttons split">
                <button class="btn-secondary" data-action="prev">⬅ 上一步</button>
                <button class="btn-primary btn-next" data-action="next">下一步 ➔</button>
            </div>
        </div>

        <div class="step-section" data-step="3" style="display: none;">
            <div class="panel-row">
                <div class="input-group options-group">
                    <label>試卷標題</label>
                    <input type="text" id="input-title" value="測驗卷">
                </div>
                <div class="input-group options-group">
                    <label>功能開關</label>
                    <div class="checkbox-group">
                        <button id="btn-open-settings" class="btn-small">⚙️ 欄位設定</button>
                        <label class="checkbox-label"><input type="checkbox" id="chk-page-break" checked> 強制分頁</label>
                        <label class="checkbox-label"><input type="checkbox" id="chk-teacher-key"> 生成解答卷</label>
                    </div>
                </div>
            </div>
            
            <div class="generation-area">
                <button id="btn-answer-sheet" class="btn-lg-secondary" style="margin-right:10px; background:#607d8b;">📄 答案卡</button>
                <button id="btn-generate" class="btn-lg-primary">🚀 生成試卷</button>
                <button id="btn-print" class="btn-lg-secondary" style="display: none;">🖨️ 列印</button>
            </div>

            <div class="nav-buttons left">
                <button class="btn-secondary" data-action="prev">⬅ 上一步</button>
            </div>
        </div>
    </div>

    <div id="output-area">
        <div class="placeholder-text">(預覽區域)</div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>表格樣式設定</h2><span class="close-modal" data-target="settings-modal">&times;</span></div>
            <div class="modal-body">
                <div class="settings-pane"><div id="modal-column-list"></div><div class="modal-actions"><button id="btn-add-col-modal" class="btn-small btn-green">+ 新增</button><button id="btn-reset-col-modal" class="btn-small btn-red">重置</button></div></div>
                <div class="preview-pane"><div id="modal-preview-area" class="preview-box"></div></div>
            </div>
            <div class="modal-footer"><button id="btn-save-settings" class="btn-primary">儲存</button></div>
        </div>
    </div>

    <div id="modal-ai-settings" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header"><h2>🤖 Google AI 設定</h2><span class="close-modal" data-target="modal-ai-settings">&times;</span></div>
            <div class="modal-body">
                <label>API Key</label><input type="password" id="input-api-key" placeholder="貼上 Key..." style="width:100%; padding:8px; margin:5px 0 10px;">
                <button id="btn-check-models" class="btn-secondary">驗證</button>
                <div id="model-select-area" style="display:none; margin-top:10px;"><label>模型</label><select id="select-model" style="width:100%; padding:8px;"></select></div>
            </div>
            <div class="modal-footer"><button id="btn-save-ai" class="btn-primary">儲存</button></div>
        </div>
    </div>

    <div id="modal-grade-result" class="modal">
        <div class="modal-content" style="max-width: 800px; height: 90vh;">
            <div class="modal-header"><h2>📷 AI 閱卷校對</h2><span class="close-modal" data-target="modal-grade-result">&times;</span></div>
            <div class="modal-body" style="display: flex; gap: 20px; padding: 0;">
                <div style="flex: 1; background: #333; display: flex; align-items: center; justify-content: center;"><img id="grade-img-preview" style="max-width: 100%; max-height: 100%;"></div>
                <div style="flex: 1; padding: 20px; overflow-y: auto;">
                    <div style="background: #e3f2fd; padding: 10px; margin-bottom: 15px;">
                        <label style="font-weight:bold; color:#1565c0;">🔑 標準答案</label>
                        <input type="text" id="input-answer-key" placeholder="A,B,C..." style="width:100%; padding:5px; font-family:monospace;">
                    </div>
                    <div style="margin-bottom:10px;"><b>座號：</b><input type="text" id="grade-seat-val" style="width:60px; text-align:center; font-weight:bold;"></div>
                    <div id="grade-details-list" style="border:1px solid #eee; padding:10px; max-height:300px; overflow-y:auto;"></div>
                    <div style="margin-top: 15px; border-top: 2px dashed #ccc; padding-top:10px;">
                        <b style="color: #d32f2f;">❌ 錯題：</b><span id="grade-error-ids" style="font-weight:bold;"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button id="btn-confirm-grade" class="btn-primary">確認並匯入</button></div>
        </div>
    </div>

    <div id="modal-history" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>📜 出題歷史紀錄</h2>
                <span class="close-modal" data-target="modal-history">&times;</span>
            </div>
            <div class="modal-body">
                <div id="history-list" class="history-list-container">
                    <div style="text-align:center; color:#888;">暫無紀錄</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary close-modal-btn">關閉</button>
            </div>
        </div>
    </div>

    <div id="modal-question-editor" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>✏️ 編輯題目</h2>
                <span class="close-modal" data-target="modal-question-editor">&times;</span>
            </div>
            <div class="modal-body">
                <form id="form-edit-question">
                    <input type="hidden" id="edit-q-index"> <div class="form-group">
                        <label>題號 (ID)</label>
                        <input type="text" id="edit-q-id" class="input-field" style="width: 100px;">
                    </div>

                    <div class="form-group">
                        <label>題目內容 (Question)</label>
                        <textarea id="edit-q-text" class="input-field" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label>題目解析 (Explanation)</label>
                        <textarea id="edit-q-expl" class="input-field" rows="2"></textarea>
                    </div>

                    <hr style="margin: 20px 0; border: 0; border-top: 1px dashed #ccc;">

                    <div class="form-group">
                        <label style="color: #9c27b0;">★ 類題內容 (Similar Question)</label>
                        <textarea id="edit-q-sim-text" class="input-field" rows="3" placeholder="若無類題，此處留空即可"></textarea>
                    </div>

                    <div class="form-group">
                        <label style="color: #9c27b0;">★ 類題解析 (Similar Explanation)</label>
                        <textarea id="edit-q-sim-expl" class="input-field" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary close-modal-btn" data-target="modal-question-editor">取消</button>
                <button id="btn-save-edit" class="btn-primary">💾 儲存修改</button>
            </div>
        </div>
    </div>

    <script type="module" src="assets/js/main.js"></script>
</body>
</html>