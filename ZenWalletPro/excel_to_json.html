<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZenWalletPro Excel è½‰æ›å·¥å…·</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f8f9fa; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 480px; }
        h2 { margin-top: 0; color: #333; text-align: center; }
        .description { color: #666; font-size: 0.9rem; margin-bottom: 1.5rem; text-align: center; }
        .upload-box { border: 2px dashed #dee2e6; border-radius: 8px; padding: 2rem; text-align: center; margin-bottom: 1.5rem; transition: border-color 0.3s; cursor: pointer; position: relative; }
        .upload-box:hover { border-color: #0d6efd; background-color: #f8faff; }
        .upload-box input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .btn { display: block; width: 100%; padding: 0.75rem; background-color: #0d6efd; color: white; border: none; border-radius: 6px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        .btn:hover { background-color: #0b5ed7; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        #log { margin-top: 1.5rem; font-size: 0.85rem; color: #555; border-top: 1px solid #eee; padding-top: 1rem; white-space: pre-wrap; }
        .success { color: #198754; }
        .error { color: #dc3545; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ“Š Excel è½‰ JSON å·¥å…·</h2>
    <p class="description">è«‹ä¸Šå‚³æ‚¨çš„è¨˜å¸³æœ¬ Excel æª” (.xlsx)ï¼Œç³»çµ±å°‡è‡ªå‹•æŠ“å–åˆ†é ä¸¦è½‰æ›ç‚º ZenWalletPro å‚™ä»½æ ¼å¼ã€‚</p>

    <div class="upload-box">
        <input type="file" id="fileInput" accept=".xlsx, .xls">
        <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ“‚</div>
        <div>é»æ“Šé¸æ“‡æˆ–æ‹–æ›³æª”æ¡ˆè‡³æ­¤</div>
    </div>

    <button id="convertBtn" class="btn" disabled>é–‹å§‹è½‰æ›ä¸¦ä¸‹è¼‰</button>
    
    <div id="log">ç­‰å¾…æª”æ¡ˆ...</div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const convertBtn = document.getElementById('convertBtn');
    const logDiv = document.getElementById('log');
    let selectedFile = null;

    // è¼”åŠ©ï¼šUUID ç”Ÿæˆ
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    // è¼”åŠ©ï¼šæ—¥æœŸè§£æ
    function parseExcelDate(dateVal) {
        if (!dateVal) return new Date().toISOString();
        // è™•ç† Excel åºåˆ—è™Ÿæ—¥æœŸ (ä¾‹å¦‚ 45325)
        if (typeof dateVal === 'number') {
            const date = new Date((dateVal - (25567 + 2)) * 86400 * 1000);
            return date.toISOString();
        }
        // è™•ç†å­—ä¸²æ—¥æœŸ
        try {
            return new Date(dateVal).toISOString();
        } catch (e) {
            return new Date().toISOString();
        }
    }

    // ç›£è½æª”æ¡ˆé¸æ“‡
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            selectedFile = e.target.files[0];
            convertBtn.disabled = false;
            logDiv.innerHTML = `å·²é¸æ“‡æª”æ¡ˆï¼š<strong>${selectedFile.name}</strong>`;
        }
    });

    // ç›£è½è½‰æ›æŒ‰éˆ•
    convertBtn.addEventListener('click', () => {
        if (!selectedFile) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                const db = {
                    transactions: [],
                    accounts: [],
                    categories: [],
                    tags: [],
                    portfolio: [],
                    recurring_rules: [],
                    templates: [],
                    asset_history: [],
                    meta: {
                        version: 2,
                        exportedAt: new Date().toISOString(),
                        platform: 'ZenWalletPro_ExcelTool'
                    }
                };

                let logs = [];

                // Helper: è®€å– Sheet
                const getSheetData = (sheetName) => {
                    const sheet = workbook.Sheets[sheetName];
                    return sheet ? XLSX.utils.sheet_to_json(sheet) : null;
                };

                // 1. äº¤æ˜“ç´€éŒ„
                const transData = getSheetData('äº¤æ˜“ç´€éŒ„');
                if (transData) {
                    db.transactions = transData.map(row => ({
                        id: row['ID'] || generateUUID(),
                        date: parseExcelDate(row['æ—¥æœŸ']),
                        type: row['é¡å‹'] || 'æ”¯å‡º',
                        category: row['é¡åˆ¥'] || 'æœªåˆ†é¡',
                        account: row['å¸³æˆ¶'] || 'ç¾é‡‘',
                        item: row['é …ç›®'] || 'æœªå‘½å',
                        amount: parseFloat(row['é‡‘é¡']) || 0,
                        notes: row['å‚™è¨»'] || '',
                        tags: row['æ¨™ç±¤'] ? [row['æ¨™ç±¤']] : [],
                        createdAt: new Date().toISOString()
                    }));
                    logs.push(`âœ… äº¤æ˜“ç´€éŒ„: ${db.transactions.length} ç­†`);
                } else {
                    logs.push(`âš ï¸ æ‰¾ä¸åˆ°åˆ†é : [äº¤æ˜“ç´€éŒ„]`);
                }

                // 2. å¸³æˆ¶è¨­å®š
                const accData = getSheetData('å¸³æˆ¶è¨­å®š');
                if (accData) {
                    db.accounts = accData.map(row => ({
                        id: generateUUID(),
                        name: row['å¸³æˆ¶åç¨±'],
                        initial: 0,
                        createdAt: new Date().toISOString()
                    }));
                    logs.push(`âœ… å¸³æˆ¶è¨­å®š: ${db.accounts.length} ç­†`);
                }

                // 3. é¡åˆ¥è¨­å®š
                const catData = getSheetData('é¡åˆ¥è¨­å®š');
                if (catData) {
                    db.categories = catData.map(row => ({
                        id: generateUUID(),
                        name: row['é¡åˆ¥åç¨±'],
                        type: row['é¡å‹'],
                        createdAt: new Date().toISOString()
                    }));
                    logs.push(`âœ… é¡åˆ¥è¨­å®š: ${db.categories.length} ç­†`);
                }

                // 4. æ¨™ç±¤è¨­å®š
                const tagData = getSheetData('æ¨™ç±¤è¨­å®š');
                if (tagData) {
                    db.tags = tagData.map(row => ({
                        id: generateUUID(),
                        name: row['æ¨™ç±¤åç¨±'],
                        createdAt: new Date().toISOString()
                    }));
                    logs.push(`âœ… æ¨™ç±¤è¨­å®š: ${db.tags.length} ç­†`);
                }

                // 5. æŠ•è³‡çµ„åˆ
                const pfData = getSheetData('æŠ•è³‡çµ„åˆ');
                if (pfData) {
                    db.portfolio = pfData.map(row => {
                        let ticker = row['è‚¡ç¥¨ä»£è™Ÿ'] || '';
                        // è½‰æ› Yahoo Finance æ ¼å¼
                        if (ticker.startsWith('TPE:')) ticker = ticker.replace('TPE:', '') + '.TW';
                        return {
                            id: generateUUID(),
                            ticker: ticker,
                            quantity: parseFloat(row['æ•¸é‡']) || 0,
                            currentPrice: parseFloat(row['å–®åƒ¹']) || 0,
                            updatedAt: new Date().toISOString()
                        };
                    });
                    logs.push(`âœ… æŠ•è³‡çµ„åˆ: ${db.portfolio.length} ç­†`);
                }

                // æ›´æ–° Log
                logDiv.innerHTML = `<span class="success">è½‰æ›æˆåŠŸï¼</span><br>` + logs.join('<br>');

                // ä¸‹è¼‰æª”æ¡ˆ
                const jsonString = JSON.stringify(db, null, 2);
                const blob = new Blob([jsonString], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `zenwallet_import_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (err) {
                console.error(err);
                logDiv.innerHTML = `<span class="error">âŒ éŒ¯èª¤: ${err.message}</span>`;
            }
        };
        reader.readAsArrayBuffer(selectedFile);
    });
</script>

</body>
</html>