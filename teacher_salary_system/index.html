<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教師課務薪資系統 (本地專業版)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; padding: 0; height: 100vh; overflow: hidden; background-color: #f8f9fa; }
        .layout-container { display: flex; height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 240px; min-width: 240px; background-color: #ffffff; border-right: 1px solid #dee2e6; display: flex; flex-direction: column; padding: 15px; overflow-y: auto; z-index: 10; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        .month-header { font-size: 0.85rem; font-weight: bold; color: #6c757d; margin-top: 15px; margin-bottom: 5px; padding-left: 5px; border-bottom: 1px solid #e9ecef; }
        .week-card { padding: 8px 10px; margin-bottom: 6px; background: white; border: 1px solid #dee2e6; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; }
        .week-card:hover { border-color: #0d6efd; background-color: #e7f1ff; }
        .week-card.active { background-color: #0d6efd; color: white; border-color: #0d6efd; }
        
        /* Main Content */
        .main-content { flex-grow: 1; padding: 20px; overflow-y: auto; position: relative; display: flex; flex-direction: column; }
        
        .calendar-grid { 
            display: grid; 
            grid-template-columns: 50px repeat(7, 1fr);
            gap: 2px; 
            background-color: #dee2e6; 
            border: 1px solid #dee2e6; 
            flex-grow: 1;
            overflow-y: auto;
            min-height: 0; /* Important for flex scroll */
        }

        .header-cell { font-weight: bold; text-align: center; background: #f8f9fa; padding: 10px; position: sticky; top: 0; z-index: 5; border-bottom: 1px solid #ddd; }
        .header-cell.weekend { background-color: #e9ecef; color: #d63384; }

        .period-cell { min-height: 80px; background-color: white; cursor: pointer; padding: 0; position: relative; transition: bg 0.2s;}
        .period-cell:hover { background-color: #f1f3f5; }
        .class-block { width: 100%; height: 100%; min-height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; font-size: 0.9rem; color: white; padding: 2px; }
        .class-name-tag { font-size: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 4px; padding: 0 4px; margin-top: 2px; }
        .is-preview { opacity: 0.5; border: 2px dashed rgba(0,0,0,0.1); color: #000 !important; background-color: #e9ecef !important; }

        /* Color Tags will be dynamic now, but keeping defaults */
        .tag-default { background-color: #6c757d; color: white; }
    </style>
</head>
<body>
    <div class="layout-container">
        <aside class="sidebar">
            <h5 class="mb-3 text-primary"><i class="bi bi-calendar-check"></i> 課務薪資系統</h5>
            <button class="btn btn-outline-primary btn-sm mb-2 w-100" onclick="jumpToToday()">回到本週</button>
            <hr>
            <div class="d-grid gap-2">
                <button class="btn btn-light btn-sm text-start" onclick="openSemesterModal()"><i class="bi bi-calendar-range"></i> 學期設定</button>
                <button class="btn btn-light btn-sm text-start" onclick="openSettingsModal()"><i class="bi bi-gear"></i> 課程類別設定</button>
                <button class="btn btn-light btn-sm text-start" onclick="openBackupModal()"><i class="bi bi-database-down"></i> 備份與還原</button>
            </div>
            <hr>
            <div id="sidebarList"></div>
        </aside>

        <main class="main-content">
            <div class="container-fluid p-0 d-flex flex-column h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h4 class="m-0 d-inline-block me-3" id="currentSemesterLabel">載入中...</h4>
                        <span id="currentWeekRange" class="text-secondary"></span>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary" onclick="changeWeek(-7)"><i class="bi bi-chevron-left"></i></button>
                        <button class="btn btn-outline-secondary" onclick="changeWeek(7)"><i class="bi bi-chevron-right"></i></button>
                        <button class="btn btn-success ms-2" onclick="openStatsModal()"><i class="bi bi-calculator"></i> 統計報表</button>
                    </div>
                </div>
                
                <div id="semesterAlert" class="alert alert-warning py-2" style="display:none;">
                    <i class="bi bi-exclamation-triangle"></i> 目前日期不在任何已設定的學期範圍內，請先設定學期。
                </div>

                <div id="calendar" class="calendar-grid"></div>
            </div>
        </main>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">編輯課程</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="modalDate"><input type="hidden" id="modalPeriod">
                    <div class="alert alert-light border mb-3 py-2">
                        <div class="d-flex justify-content-between"><small class="text-muted">基本課表：</small><span id="modalBaseInfo" class="fw-bold text-primary">-</span></div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">課程類別</label>
                        <select class="form-select" id="modalType"></select> </div>
                    
                    <div class="row g-2 mb-3">
                         <div class="col-md-12">
                            <label class="form-label">班級/地點</label>
                            <input type="text" class="form-control" id="modalClass" placeholder="ex: 101">
                        </div>
                    </div>
                    <div class="mb-3"><label class="form-label">備註</label><input type="text" class="form-control" id="modalNote"></div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-outline-danger" id="btnDelete" onclick="deleteRecord()">刪除/還原</button>
                    <button type="button" class="btn btn-primary ms-auto" onclick="saveRecord()">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="semesterModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">學期管理</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="row g-2 mb-3 align-items-end">
                        <div class="col-md-3"><label>學期名稱</label><input type="text" id="semName" class="form-control" placeholder="112-1"></div>
                        <div class="col-md-3"><label>開始日期</label><input type="date" id="semStart" class="form-control"></div>
                        <div class="col-md-3"><label>結束日期</label><input type="date" id="semEnd" class="form-control"></div>
                        <div class="col-md-3"><button class="btn btn-primary w-100" onclick="saveSemester()">新增/更新學期</button></div>
                    </div>
                    <hr>
                    <h6>已儲存學期列表 (點擊編輯基本課表)</h6>
                    <div class="list-group" id="semesterList"></div>
                    
                    <div id="baseScheduleEditor" class="mt-4" style="display:none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-primary fw-bold" id="editorTitle">編輯基本課表</h6>
                            <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('baseScheduleEditor').style.display='none'">關閉</button>
                        </div>
                        <p class="small text-muted">請在下方設定此學期的固定課表 (週一至週五)。變更將即時儲存。</p>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm text-center align-middle">
                                <thead class="table-light"><tr><th>節</th><th>一</th><th>二</th><th>三</th><th>四</th><th>五</th></tr></thead>
                                <tbody id="baseScheduleBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">課程類別設定</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <table class="table table-striped">
                        <thead><tr><th>名稱</th><th>單價</th><th>顏色</th><th>操作</th></tr></thead>
                        <tbody id="courseTypesBody"></tbody>
                        <tfoot>
                            <tr>
                                <td><input type="text" class="form-control form-control-sm" id="newTypeName" placeholder="名稱"></td>
                                <td><input type="number" class="form-control form-control-sm" id="newTypeRate" placeholder="420"></td>
                                <td><input type="color" class="form-control form-control-sm form-control-color" id="newTypeColor" value="#0d6efd"></td>
                                <td><button class="btn btn-sm btn-success" onclick="addCourseType()"><i class="bi bi-plus"></i></button></td>
                            </tr>
                        </tfoot>
                    </table>
                    <div class="alert alert-info small mt-2">
                        <i class="bi bi-info-circle"></i> 這裡設定的單價將用於薪資試算。
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="statsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">薪資試算與匯出</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="row g-2 mb-3">
                        <div class="col-md-5"><label>開始</label><input type="date" id="statsStart" class="form-control"></div>
                        <div class="col-md-5"><label>結束</label><input type="date" id="statsEnd" class="form-control"></div>
                        <div class="col-md-2 d-flex align-items-end"><button class="btn btn-primary w-100" onclick="calculateStats()">計算</button></div>
                    </div>
                    <div class="mb-3">
                        <label>每週基本節數 (超過計為超鐘點)</label>
                        <input type="number" id="weeklyQuota" class="form-control" value="16">
                    </div>
                    <table class="table table-bordered">
                        <thead class="table-light"><tr><th>項目</th><th>節數</th><th>單價</th><th>小計</th></tr></thead>
                        <tbody id="statsBody"></tbody>
                        <tfoot class="table-light"><tr><td colspan="3" class="text-end fw-bold">總計：</td><td class="fw-bold text-danger" id="statsTotal">$0</td></tr></tfoot>
                    </table>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" onclick="exportStatsExcel()">匯出 Excel</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="backupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">資料庫備份與還原</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body text-center">
                    <p>將所有資料（設定、學期、紀錄）下載為 JSON 檔案。</p>
                    <button class="btn btn-primary mb-3" onclick="exportBackup()"><i class="bi bi-download"></i> 下載備份 (JSON)</button>
                    <hr>
                    <p>從 JSON 檔案還原資料（將覆蓋現有資料）。</p>
                    <input type="file" id="importFile" class="form-control mb-2" accept=".json">
                    <button class="btn btn-danger" onclick="importBackup()"><i class="bi bi-upload"></i> 確認還原</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- 1. 資料庫設定 (Dexie) ---
        const db = new Dexie("TeacherSalaryDB");
        db.version(1).stores({
            semesters: "++id, name, startDate, endDate", // 學期
            records: "++id, [date+period], date, type, semesterId", // 課程異動紀錄
            settings: "key" // 系統設定 (課程類別等)
        });

        // 預設資料
        const defaultTypes = [
            { id: 1, name: '基本鐘點', rate: 0, color: '#0d6efd' },
            { id: 2, name: '超鐘點', rate: 420, color: '#198754' },
            { id: 3, name: '代課', rate: 420, color: '#ffc107' },
            { id: 4, name: '晚自習', rate: 550, color: '#6f42c1' },
            { id: 5, name: '請假', rate: 0, color: '#dc3545' }
        ];

        // --- 全域變數 ---
        let currentDate = new Date();
        let currentSemester = null; // 當前日期所屬的學期物件
        let courseTypes = []; 
        let currentEditingSemId = null; // for base schedule editor

        // --- 初始化 ---
        window.onload = async function() {
            await loadSettings();
            jumpToToday();
        };

        // --- 核心邏輯：資料載入與計算 ---
        async function loadSettings() {
            let types = await db.settings.get('courseTypes');
            if (!types) {
                await db.settings.put({ key: 'courseTypes', value: defaultTypes });
                courseTypes = defaultTypes;
            } else {
                courseTypes = types.value;
            }
        }

        async function determineSemester(date) {
            const dateStr = formatDate(date);
            // 找出包含此日期的學期
            const semesters = await db.semesters.toArray();
            const found = semesters.find(s => dateStr >= s.startDate && dateStr <= s.endDate);
            return found || null;
        }

        async function renderCalendar() {
            const grid = document.getElementById('calendar');
            grid.innerHTML = '<div class="col-12 text-center py-5">載入資料中...</div>';

            const startOfWeek = new Date(currentDate);
            startOfWeek.setDate(currentDate.getDate() - currentDate.getDay()); // 週日
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6); // 週六
            
            // UI 更新
            document.getElementById('currentWeekRange').innerText = `${formatDate(startOfWeek)} ~ ${formatDate(endOfWeek)}`;
            renderSidebar(currentDate);

            // 1. 判斷學期
            // 簡單起見，我們以「週四」所在的學期為主 (ISO週原則)，或直接檢查週一
            // 這裡採用檢查週三，盡量捕捉學期中
            let checkDate = new Date(startOfWeek); checkDate.setDate(checkDate.getDate()+3);
            currentSemester = await determineSemester(checkDate);

            const semLabel = document.getElementById('currentSemesterLabel');
            const alertBox = document.getElementById('semesterAlert');
            
            if(currentSemester) {
                semLabel.innerText = currentSemester.name;
                alertBox.style.display = 'none';
            } else {
                semLabel.innerText = "無學期設定";
                alertBox.style.display = 'block';
            }

            // 2. 準備 Grid HTML
            grid.innerHTML = '';
            const weekDays = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
            let headerHtml = `<div class="header-cell">節次</div>`;
            for(let i=0; i<7; i++) {
                let d = new Date(startOfWeek); d.setDate(d.getDate() + i);
                let isWeekend = (i===0 || i===6) ? 'weekend' : '';
                headerHtml += `<div class="header-cell ${isWeekend}">${weekDays[i]}<br><small class="fw-normal">${d.getMonth()+1}/${d.getDate()}</small></div>`;
            }
            grid.innerHTML += headerHtml;

            // 3. 讀取此週紀錄
            const startStr = formatDate(startOfWeek);
            const endStr = formatDate(endOfWeek);
            const records = await db.records.where('date').between(startStr, endStr, true, true).toArray();
            
            // 轉成 Map 方便查找: key = "2025-01-01-1" (date-period)
            let recordMap = {};
            records.forEach(r => recordMap[`${r.date}-${r.period}`] = r);

            // 4. 繪製格子 (12節)
            for (let p = 1; p <= 12; p++) {
                grid.innerHTML += `<div class="header-cell d-flex align-items-center justify-content-center bg-light">${p}</div>`;
                
                for (let col = 0; col < 7; col++) {
                    let cellDate = new Date(startOfWeek); cellDate.setDate(cellDate.getDate() + col);
                    let dateStr = formatDate(cellDate);
                    let dayOfWeek = cellDate.getDay(); // 0-6

                    // 取得資料
                    let record = recordMap[`${dateStr}-${p}`];
                    let baseInfo = null;

                    // 從學期設定中讀取基本課表 (dayOfWeek 1-5)
                    // baseSchedule 格式: { "1-1": {type, class}, ... } Key="Day-Period"
                    if (currentSemester && currentSemester.baseSchedule && dayOfWeek >= 1 && dayOfWeek <= 5) {
                        baseInfo = currentSemester.baseSchedule[`${dayOfWeek}-${p}`];
                    }

                    // 決定顯示內容
                    let displayType = "", displayClass = "", displayNote = "", boxClass = "", isPreview = false;
                    let colorCode = "#6c757d"; // default gray

                    if (record) {
                        displayType = record.type;
                        displayClass = record.className || "";
                        displayNote = record.note || "";
                        // 找顏色
                        let typeConfig = courseTypes.find(t => t.name === displayType);
                        if(typeConfig) colorCode = typeConfig.color;
                    } else if (baseInfo && baseInfo.type) {
                        displayType = baseInfo.type;
                        displayClass = baseInfo.className || "";
                        isPreview = true;
                        let typeConfig = courseTypes.find(t => t.name === displayType);
                        if(typeConfig) colorCode = typeConfig.color; // Preview color usually lighter, handled by css opacity
                    }

                    let cellContent = "";
                    if (displayType) {
                        let style = `background-color: ${colorCode};`;
                        let previewClass = isPreview ? 'is-preview' : '';
                        // 修正 preview 的顏色邏輯，透過 CSS opacity 處理
                        if(isPreview) style = `background-color: #e9ecef; color: black; border: 2px dashed ${colorCode};`; 
                        else style = `background-color: ${colorCode}; color: white;`;

                        cellContent = `
                            <div class="class-block" style="${style}">
                                <span class="fw-bold">${displayType}</span>
                                ${displayClass ? `<div class="class-name-tag">${displayClass}</div>` : ''}
                                ${displayNote ? `<small>(${displayNote})</small>` : ''}
                            </div>`;
                    }

                    // 準備參數傳給 Modal
                    const safe = (s) => s ? s.replace(/'/g, "&apos;") : "";
                    const baseTypeSafe = baseInfo ? safe(baseInfo.type) : "";
                    
                    grid.innerHTML += `
                        <div class="period-cell" onclick="openEditModal('${dateStr}', ${p}, '${safe(displayType)}', '${safe(displayClass)}', '${safe(displayNote)}', ${!!record}, '${baseTypeSafe}')">
                            ${cellContent}
                        </div>`;
                }
            }
        }

        // --- Modal 操作 ---
        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
        
        function openEditModal(date, period, currentType, currentClass, currentNote, hasRecord, baseType) {
            document.getElementById('modalDate').value = date;
            document.getElementById('modalPeriod').value = period;
            document.getElementById('modalBaseInfo').innerText = baseType || "空堂";
            
            // 填充選單
            const select = document.getElementById('modalType');
            select.innerHTML = '';
            courseTypes.forEach(t => {
                select.innerHTML += `<option value="${t.name}">${t.name}</option>`;
            });
            // 預設選中
            if (currentType) {
                select.value = currentType;
            } else if (baseType) {
                select.value = baseType; // 預設帶入基本課表
            } else {
                select.value = "基本鐘點";
            }

            document.getElementById('modalClass').value = currentClass;
            document.getElementById('modalNote').value = currentNote;

            // 控制刪除按鈕
            const btnDelete = document.getElementById('btnDelete');
            if (hasRecord) {
                btnDelete.innerText = "還原至基本/刪除";
                btnDelete.style.display = 'block';
            } else {
                btnDelete.style.display = 'none';
            }

            editModal.show();
        }

        async function saveRecord() {
            const date = document.getElementById('modalDate').value;
            const period = parseInt(document.getElementById('modalPeriod').value);
            const type = document.getElementById('modalType').value;
            const className = document.getElementById('modalClass').value;
            const note = document.getElementById('modalNote').value;

            // 檢查是否已存在 (update or add)
            const existing = await db.records.where('[date+period]').equals([date, period]).first();
            
            const data = {
                date: date,
                period: period,
                type: type,
                className: className,
                note: note,
                semesterId: currentSemester ? currentSemester.id : null
            };

            if (existing) {
                await db.records.update(existing.id, data);
            } else {
                await db.records.add(data);
            }

            editModal.hide();
            renderCalendar(); // 重繪
        }

        async function deleteRecord() {
            const date = document.getElementById('modalDate').value;
            const period = parseInt(document.getElementById('modalPeriod').value);
            // 刪除紀錄 (即還原成基本課表狀態)
            await db.records.where('[date+period]').equals([date, period]).delete();
            editModal.hide();
            renderCalendar();
        }

        // --- 學期設定邏輯 ---
        const semModal = new bootstrap.Modal(document.getElementById('semesterModal'));
        function openSemesterModal() {
            loadSemesterList();
            document.getElementById('baseScheduleEditor').style.display = 'none';
            semModal.show();
        }

        async function loadSemesterList() {
            const list = document.getElementById('semesterList');
            const sems = await db.semesters.toArray();
            list.innerHTML = '';
            sems.forEach(s => {
                list.innerHTML += `
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="editBaseSchedule(${s.id})">
                        <div>
                            <strong>${s.name}</strong> <small class="text-muted">(${s.startDate} ~ ${s.endDate})</small>
                        </div>
                        <span class="badge bg-secondary rounded-pill">編輯課表</span>
                    </button>`;
            });
        }

        async function saveSemester() {
            const name = document.getElementById('semName').value;
            const start = document.getElementById('semStart').value;
            const end = document.getElementById('semEnd').value;
            if(!name || !start || !end) { alert('請填寫完整資訊'); return; }

            // 簡單處理：如果名稱一樣視為更新，否則新增 (實務上應用 ID)
            const existing = await db.semesters.where('name').equals(name).first();
            if(existing) {
                await db.semesters.update(existing.id, { startDate: start, endDate: end });
            } else {
                await db.semesters.add({ name: name, startDate: start, endDate: end, baseSchedule: {} });
            }
            // 清空輸入
            document.getElementById('semName').value = '';
            loadSemesterList();
            renderCalendar(); // 更新主畫面
        }

        async function editBaseSchedule(semId) {
            currentEditingSemId = semId;
            const sem = await db.semesters.get(semId);
            document.getElementById('editorTitle').innerText = `編輯 ${sem.name} 基本課表`;
            document.getElementById('baseScheduleEditor').style.display = 'block';
            
            const tbody = document.getElementById('baseScheduleBody');
            tbody.innerHTML = '';
            
            // 產生 1-8 節 (假設基本課表編輯到第8節，可自行擴充)
            for(let p=1; p<=9; p++) {
                let tr = `<tr><td>${p}</td>`;
                for(let d=1; d<=5; d++) {
                    const key = `${d}-${p}`;
                    const cellData = sem.baseSchedule[key] || {};
                    const type = cellData.type || "";
                    const cls = cellData.className || "";
                    
                    // 簡化：點擊輸入文字
                    tr += `<td class="p-1">
                        <input type="text" class="form-control form-control-sm mb-1" placeholder="科目" 
                            value="${type}" onchange="updateBaseCell(${semId}, ${d}, ${p}, 'type', this.value)">
                        <input type="text" class="form-control form-control-sm" placeholder="班級" style="font-size:0.7rem;"
                            value="${cls}" onchange="updateBaseCell(${semId}, ${d}, ${p}, 'className', this.value)">
                    </td>`;
                }
                tr += `</tr>`;
                tbody.innerHTML += tr;
            }
        }

        async function updateBaseCell(semId, day, period, field, value) {
            const sem = await db.semesters.get(semId);
            const key = `${day}-${period}`;
            if (!sem.baseSchedule[key]) sem.baseSchedule[key] = {};
            sem.baseSchedule[key][field] = value;
            
            // 如果清空科目，則移除該 entry
            if (field === 'type' && value === '') delete sem.baseSchedule[key];
            
            await db.semesters.update(semId, { baseSchedule: sem.baseSchedule });
            // 更新目前畫面
            if(currentSemester && currentSemester.id === semId) renderCalendar();
        }

        // --- 課程類別設定 ---
        const settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
        function openSettingsModal() {
            renderSettingsTable();
            settingsModal.show();
        }
        function renderSettingsTable() {
            const tbody = document.getElementById('courseTypesBody');
            tbody.innerHTML = '';
            courseTypes.forEach((t, idx) => {
                tbody.innerHTML += `
                    <tr>
                        <td><input type="text" class="form-control form-control-sm" value="${t.name}" onchange="updateType(${idx}, 'name', this.value)"></td>
                        <td><input type="number" class="form-control form-control-sm" value="${t.rate}" onchange="updateType(${idx}, 'rate', this.value)"></td>
                        <td><input type="color" class="form-control form-control-sm form-control-color" value="${t.color}" onchange="updateType(${idx}, 'color', this.value)"></td>
                        <td><button class="btn btn-sm btn-outline-danger" onclick="removeType(${idx})"><i class="bi bi-trash"></i></button></td>
                    </tr>`;
            });
        }
        async function addCourseType() {
            const name = document.getElementById('newTypeName').value;
            const rate = document.getElementById('newTypeRate').value;
            const color = document.getElementById('newTypeColor').value;
            if(!name) return;
            courseTypes.push({ name, rate: parseInt(rate)||0, color });
            await db.settings.put({ key: 'courseTypes', value: courseTypes });
            document.getElementById('newTypeName').value = '';
            renderSettingsTable();
            renderCalendar();
        }
        async function updateType(index, field, value) {
            courseTypes[index][field] = (field === 'rate') ? parseInt(value) : value;
            await db.settings.put({ key: 'courseTypes', value: courseTypes });
            renderCalendar();
        }
        async function removeType(index) {
            if(confirm('確定刪除此類別？')) {
                courseTypes.splice(index, 1);
                await db.settings.put({ key: 'courseTypes', value: courseTypes });
                renderSettingsTable();
                renderCalendar();
            }
        }

        // --- 統計報表 ---
        const statsModal = new bootstrap.Modal(document.getElementById('statsModal'));
        function openStatsModal() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('statsStart').value = formatDate(firstDay);
            document.getElementById('statsEnd').value = formatDate(today);
            statsModal.show();
        }

        async function calculateStats() {
            const startStr = document.getElementById('statsStart').value;
            const endStr = document.getElementById('statsEnd').value;
            const quota = parseInt(document.getElementById('weeklyQuota').value) || 16;
            
            const records = await db.records.where('date').between(startStr, endStr, true, true).toArray();
            
            // 統計邏輯
            let summary = {}; // Key: TypeName, Value: Count
            // 先初始化
            courseTypes.forEach(t => summary[t.name] = 0);
            // 額外處理「基本鐘點」的超鐘點計算 -> 需按週分組
            // 這裡採用簡化邏輯：
            // 1. 遍歷每一天，若該天有紀錄則用紀錄，無紀錄則看是否為基本課表
            // 這需要非常複雜的迴圈 (Iterate dates)，為求效能與簡潔，
            // **這裡示範：只統計「紀錄表」中的項目**。
            // 若要包含「預設未更動的基本課表」，需要 Generate Date Range Loop.
            
            // --- 進階統計：包含預設基本課表 ---
            let totalCounts = {}; // Type -> Count
            courseTypes.forEach(t => totalCounts[t.name] = 0);
            
            let currentDateIter = new Date(startStr);
            const endDateIter = new Date(endStr);
            
            // 為了計算超鐘點，需按週統計節數
            let weeklyCounts = {}; // "2025-W10": count

            // 預先抓取區間內的所有紀錄 map
            let recordMap = {};
            records.forEach(r => recordMap[`${r.date}-${r.period}`] = r);

            // 載入區間內可能跨越的學期
            const allSems = await db.semesters.toArray();

            while(currentDateIter <= endDateIter) {
                let dStr = formatDate(currentDateIter);
                let day = currentDateIter.getDay(); // 0-6
                let weekKey = getWeekKey(currentDateIter);
                if(!weeklyCounts[weekKey]) weeklyCounts[weekKey] = 0;

                // 判斷當天學期
                let sem = allSems.find(s => dStr >= s.startDate && dStr <= s.endDate);

                for(let p=1; p<=12; p++) {
                    let type = null;
                    let isMoney = false; // 是否計入節數 (基本/超鐘點)

                    // 1. 查紀錄
                    if (recordMap[`${dStr}-${p}`]) {
                        type = recordMap[`${dStr}-${p}`].type;
                    } 
                    // 2. 查基本 (若無紀錄且有學期)
                    else if (sem && sem.baseSchedule && sem.baseSchedule[`${day}-${p}`]) {
                        type = sem.baseSchedule[`${day}-${p}`].type;
                    }

                    if (type) {
                        if(!totalCounts[type]) totalCounts[type] = 0;
                        totalCounts[type]++;
                        
                        // 判斷是否計入每週基本節數 (排除 代課/晚自習/請假 等特殊項，視使用者定義)
                        // 假設：只有 "基本鐘點" 和 "超鐘點" 這類名稱會佔用 Quota
                        // 或簡單邏輯：除了 "代課"、"晚自習" 以外都算本職節數
                        if (!type.includes('代課') && !type.includes('晚自習') && !type.includes('請假')) {
                            weeklyCounts[weekKey]++;
                        }
                    }
                }
                currentDateIter.setDate(currentDateIter.getDate() + 1);
            }

            // 計算超鐘點
            let overtimeTotal = 0;
            for(let wk in weeklyCounts) {
                if (weeklyCounts[wk] > quota) {
                    overtimeTotal += (weeklyCounts[wk] - quota);
                }
            }

            // 渲染表格
            const tbody = document.getElementById('statsBody');
            tbody.innerHTML = '';
            let moneyTotal = 0;

            // 1. 顯示一般分類統計 (代課、晚自習...)
            courseTypes.forEach(t => {
                // 如果是基本鐘點或超鐘點，我們在下方統一用 Overtime 呈現，這裡只列出特殊項目?
                // 或者列出所有Raw Count，最後一行加 Overtime Bonus.
                // 這裡採用：列出所有 Raw Count * Rate
                // 但通常 "基本鐘點" Rate = 0，只有超出的才算錢。
                
                let count = totalCounts[t.name] || 0;
                if (count > 0) {
                    let sub = count * t.rate;
                    // 如果是基本鐘點，通常不在此計算金額(薪水已含)，除非是兼課
                    // 為了避免混淆，這裡只列出，不加總基本鐘點的金額 (假設 Rate設為0)
                    moneyTotal += sub;
                    
                    tbody.innerHTML += `<tr>
                        <td>${t.name}</td>
                        <td>${count}</td>
                        <td>${t.rate}</td>
                        <td>${sub}</td>
                    </tr>`;
                }
            });

            // 2. 額外顯示「超鐘點計算結果」
            // 這是比較複雜的邏輯：通常是 (總節數 - 基本) * 400
            // 或是 已經在 CourseType 設定好 "超鐘點" 這個類別
            // 若使用者手動將課表改為 "超鐘點"，則上面已經算過了。
            // 若使用者依賴 "基本鐘點" 自動溢算，則需顯示在此：
            if (overtimeTotal > 0) {
                // 假設超鐘點費率
                let overRate = 420; 
                let overSub = overtimeTotal * overRate;
                // moneyTotal += overSub; // 視需求決定是否累加
                tbody.innerHTML += `<tr class="table-warning fw-bold">
                    <td>[系統試算] 超出基本節數</td>
                    <td>${overtimeTotal}</td>
                    <td>${overRate}</td>
                    <td>(僅供參考)</td>
                </tr>`;
            }
            
            document.getElementById('statsTotal').innerText = `$${moneyTotal}`;
        }

        function exportStatsExcel() {
            const table = document.querySelector("#statsModal table");
            const wb = XLSX.utils.table_to_book(table);
            XLSX.writeFile(wb, "薪資統計.xlsx");
        }

        // --- 系統備份與還原 ---
        const backupModal = new bootstrap.Modal(document.getElementById('backupModal'));
        function openBackupModal() { backupModal.show(); }
        
        async function exportBackup() {
            const data = {
                semesters: await db.semesters.toArray(),
                records: await db.records.toArray(),
                settings: await db.settings.toArray()
            };
            const blob = new Blob([JSON.stringify(data)], {type: "application/json;charset=utf-8"});
            saveAs(blob, `TeacherSalary_Backup_${formatDate(new Date())}.json`);
        }

        async function importBackup() {
            const fileInput = document.getElementById('importFile');
            if(!fileInput.files.length) return;
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    await db.transaction('rw', db.semesters, db.records, db.settings, async () => {
                        await db.semesters.clear();
                        await db.records.clear();
                        await db.settings.clear();
                        if(data.semesters) await db.semesters.bulkAdd(data.semesters);
                        if(data.records) await db.records.bulkAdd(data.records);
                        if(data.settings) await db.settings.bulkAdd(data.settings);
                    });
                    alert('還原成功！');
                    location.reload();
                } catch(err) {
                    alert('檔案格式錯誤或損毀');
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }

        // --- 輔助函式 ---
        function jumpToToday() { currentDate = new Date(); renderCalendar(); }
        function changeWeek(d) { currentDate.setDate(currentDate.getDate() + d); renderCalendar(); }
        function formatDate(d) { return d.toISOString().split('T')[0]; }
        function getWeekKey(d) {
            let target = new Date(d);
            target.setDate(target.getDate() - target.getDay());
            return formatDate(target);
        }
        function renderSidebar(centerDate) {
            const list = document.getElementById('sidebarList');
            list.innerHTML = '';
            // 顯示前後幾週 (略，與原版類似邏輯)
            // 這裡簡化顯示本月
            let d = new Date(centerDate); d.setDate(1);
            list.innerHTML += `<div class="month-header">${d.getMonth()+1}月</div>`;
            // 可自行擴充 Sidebar 日曆導覽
        }
    </script>
</body>
</html>